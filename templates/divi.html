<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DiviMate</title>

  <link rel="icon" href="../static/img/favicon-32x32.png" type="image/png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/divi.css') }}">
  <!-- QRコード生成ライブラリの追加 -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
</head>

<body>
  <header>
    <h1 class="header-title"><a class="title" href="{{ url_for('home') }}" style="text-decoration:none;">DiviMate</a>
    </h1>
  </header>

  <main>
    <h2 id="group-title"></h2>

    <div class="split-container">
      <div id="transaction-form">
        <h2 class="group-name" id="group-name"></h2>
        <label for="payer">Payer:</label>
        <select id="payer"></select>

        <label for="recipient">Recipient(s):</label>
        <div id="recipient-list"></div>

        <label for="amount">Amount:</label>
        <input type="number" id="amount" placeholder="Enter amount" required>

        <label for="currency">Currency:</label>
        <select id="currency">
          <option value="EUR">€ EUR</option>
          <option value="USD">$ USD</option>
          <option value="GBP">£ GBP</option>
          <option value="JPY">¥ JPY</option>
        </select>

        <label for="purpose">Purpose:</label>
        <select id="purpose">
          <option value="">Select a purpose...</option>
          <option value="Taxi">Taxi</option>
          <option value="Dinner">Dinner</option>
          <option value="Shopping">Shopping</option>
          <option value="Other">Other (please specify)</option>
        </select>
        <input type="text" id="custom-purpose" placeholder="Enter custom purpose" style="display: none;">

        <label for="transaction-date">Date:</label>
        <input type="date" id="transaction-date" required>

        <button id="add-transaction-btn">Add Transaction</button>
      </div>

      <div class="transactions-container">
        <h3>Transaction History</h3>
        <ul id="result-list" class="transaction-list"></ul>
      </div>

      <div class="settlement-container">
        <h3>Final Settlement</h3>
        <ul id="summary-list" class="settlement-list"></ul>
      </div>

      <!-- グループの URL 表示欄 -->
      <div id="shareable-url-container">
        <h3>Shareable Link:</h3>
        <div class="share-link-container">
          <input type="text" id="shareable-link" readonly>
          <button id="copy-btn">Copy Link</button>
        </div>
        <div class="qr-code-container">
          <div id="qrcode"></div>
          <p class="qr-instruction">Scan to share this group</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // エンドポイントURLを定義
    const API_ENDPOINTS = {
      transactions: "{{ url_for('add_transaction') }}",
      calculate: "{{ url_for('calculate') }}",
      fetchTransactions: "{{ url_for('get_transactions') }}"
    };

    document.addEventListener("DOMContentLoaded", () => {
      const payerSelect = document.getElementById("payer");
      const recipientList = document.getElementById("recipient-list");
      const resultList = document.getElementById("result-list");
      const summaryList = document.getElementById("summary-list");
      const shareableLink = document.getElementById("shareable-link");
      let transactions = [];

      // サーバーから渡されたテンプレート変数をJavaScriptで使用
      const groupUrl = "{{ group_url }}";
      const groupName = "{{ group_name }}";
      const members = JSON.parse('{{ members|tojson }}');

      // グループ名の設定
      document.getElementById("group-name").textContent = groupName || "No group name set";

      // データがない場合はホームに戻る
      if (!groupName || members.length === 0) {
        alert("No group data found. Returning to home.");
        window.location.href = "{{ url_for('home') }}";
        return;
      }

      // 初期化時に現在の日付をセット
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("transaction-date").value = today;

      // メンバー情報の設定
      members.forEach(member => {
        // 支払者選択肢の追加
        const payerOption = document.createElement("option");
        payerOption.value = member;
        payerOption.textContent = member;
        payerSelect.appendChild(payerOption);

        // 受取者チェックボックスの追加（より使いやすいレイアウトに）
        const recipientLabel = document.createElement("label");
        recipientLabel.className = "recipient-label";
        recipientLabel.style.display = "inline-block";
        recipientLabel.style.marginRight = "15px";
        recipientLabel.style.marginBottom = "8px";

        const recipientCheckbox = document.createElement("input");
        recipientCheckbox.type = "checkbox";
        recipientCheckbox.value = member;
        recipientCheckbox.name = "recipient";
        recipientCheckbox.style.marginRight = "5px";

        recipientLabel.appendChild(recipientCheckbox);
        recipientLabel.appendChild(document.createTextNode(member));
        recipientList.appendChild(recipientLabel);
      });

      // 目的選択の処理
      const purposeSelect = document.getElementById("purpose");
      const customPurposeInput = document.getElementById("custom-purpose");
      purposeSelect.onchange = () => {
        customPurposeInput.style.display = purposeSelect.value === "Other" ? "block" : "none";
      };

      // 取引追加ボタンの処理
      document.getElementById("add-transaction-btn").onclick = async () => {
        const amount = parseFloat(document.getElementById("amount").value);
        const currency = document.getElementById("currency").value;
        const payer = payerSelect.value;
        const recipients = Array.from(document.querySelectorAll("input[name='recipient']:checked")).map(cb => cb.value);
        const date = document.getElementById("transaction-date").value;
        const purpose = purposeSelect.value === "Other" ? customPurposeInput.value.trim() : purposeSelect.value;

        if (!amount || !payer || recipients.length === 0 || !date || !purpose) {
          alert("Please fill all fields correctly.");
          return;
        }

        try {
          const response = await fetch(API_ENDPOINTS.transactions, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              groupUrl,
              payer,
              recipients,
              amount: amount.toFixed(2),
              currency,
              purpose,
              date
            })
          });

          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          const data = await response.json();
          transactions.push(data);
          updateTransactionList();
          calculateFinalBalances();

          // フォームをリセットしつつ、日付は今日の日付を保持
          document.getElementById("amount").value = "";
          customPurposeInput.value = "";
          purposeSelect.value = "";
          customPurposeInput.style.display = "none";
          document.querySelectorAll("input[name='recipient']:checked").forEach(cb => cb.checked = false);
        } catch (error) {
          alert(error.message || "Failed to save transaction.");
        }
      };

      // 取引一覧の更新
      function updateTransactionList() {
        resultList.innerHTML = "";

        if (transactions.length === 0) {
          const emptyMessage = document.createElement("li");
          emptyMessage.className = "empty-message";
          emptyMessage.textContent = "No transactions yet. Add your first transaction!";
          emptyMessage.style.fontStyle = "italic";
          emptyMessage.style.color = "#888";
          resultList.appendChild(emptyMessage);
          return;
        }

        transactions.forEach((txn, index) => {
          const txnContainer = document.createElement("li");
          txnContainer.className = "transaction-item";

          // 取引の詳細表示
          const txnDetails = document.createElement("div");
          txnDetails.className = "transaction-details";

          const txnHeader = document.createElement("div");
          txnHeader.className = "transaction-header";
          txnHeader.innerHTML = `
              <strong>${txn.purpose}</strong> - 
              <span class="transaction-date">${txn.date}</span>
              <span class="transaction-amount">${txn.amount} ${txn.currency}</span>
            `;

          const txnBody = document.createElement("div");
          txnBody.className = "transaction-body";
          txnBody.innerHTML = `
              <div><strong>Paid by:</strong> ${txn.payer}</div>
              <div><strong>For:</strong> ${txn.recipients.join(", ")}</div>
            `;

          // 個別の支払計算結果を表示
          const txnSplits = document.createElement("div");
          txnSplits.className = "transaction-splits";

          const amountPerPerson = parseFloat(txn.amount) / txn.recipients.length;
          txn.recipients.forEach(recipient => {
            if (recipient !== txn.payer) {
              const split = document.createElement("div");
              split.className = "transaction-split";
              split.textContent = `${recipient} → ${txn.payer} ${amountPerPerson.toFixed(2)} ${txn.currency}`;
              txnSplits.appendChild(split);
            }
          });

          txnDetails.appendChild(txnHeader);
          txnDetails.appendChild(txnBody);
          if (txnSplits.children.length > 0) {
            txnDetails.appendChild(txnSplits);
          }

          // 削除ボタン
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-transaction";
          deleteBtn.textContent = "×";
          deleteBtn.title = "Delete this transaction";
          deleteBtn.onclick = () => {
            if (confirm("Are you sure you want to delete this transaction?")) {
              transactions.splice(index, 1);
              updateTransactionList();
              calculateFinalBalances();
            }
          };

          txnContainer.appendChild(txnDetails);
          txnContainer.appendChild(deleteBtn);
          resultList.appendChild(txnContainer);
        });
      }

      // 最終的な清算結果の計算
      async function calculateFinalBalances() {
        try {
          const response = await fetch(API_ENDPOINTS.calculate, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              transactions: transactions.flatMap(({ payer, amount, recipients }) =>
                recipients.map(recipient => [payer, recipient, parseFloat(amount) / recipients.length])
              )
            })
          });

          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          const data = await response.json();
          summaryList.innerHTML = "";

          if (!Array.isArray(data) || data.length === 0) {
            const li = document.createElement("li");
            li.className = "settlement-item settlement-none";
            li.textContent = "No transactions needed (everyone is settled).";
            summaryList.appendChild(li);
          } else {
            data.forEach(({ from, to, amount }) => {
              const li = document.createElement("li");
              li.className = "settlement-item";

              const fromSpan = document.createElement("span");
              fromSpan.className = "settlement-from";
              fromSpan.textContent = from;

              const arrow = document.createElement("span");
              arrow.className = "settlement-arrow";
              arrow.textContent = " → ";

              const toSpan = document.createElement("span");
              toSpan.className = "settlement-to";
              toSpan.textContent = to;

              const amountSpan = document.createElement("span");
              amountSpan.className = "settlement-amount";
              amountSpan.textContent = ` ${amount.toFixed(2)}€`;

              li.appendChild(fromSpan);
              li.appendChild(arrow);
              li.appendChild(toSpan);
              li.appendChild(amountSpan);

              summaryList.appendChild(li);
            });
          }
        } catch (error) {
          alert(error.message || "Failed to calculate clearing results.");
          summaryList.innerHTML = "<li class='settlement-error'>⚠️ Error.</li>";
        }
      }

      // 共有リンクの処理
      document.getElementById("copy-btn").onclick = () => {
        if (!groupUrl) {
          alert("The URL of the group is not saved.");
          return;
        }
        // 現在のページのURLをそのまま使用
        const fullUrl = window.location.href;
        shareableLink.value = fullUrl;
        shareableLink.select();
        document.execCommand("copy");
        alert("Link copied to clipboard!");
      };

      // QRコードの生成
      function generateQRCode(url) {
        const qrDiv = document.getElementById('qrcode');
        qrDiv.innerHTML = ''; // 既存のQRコードをクリア

        try {
          // QRコードタイプ（0-40）とエラー訂正レベル（L,M,Q,H）
          const qr = qrcode(0, 'M');
          qr.addData(url);
          qr.make();

          // QRコードをHTMLとして作成（サイズはピクセル単位）
          const qrImg = qr.createImgTag(5, 10);
          qrDiv.innerHTML = qrImg;

          // QRコード画像にスタイルを適用
          const img = qrDiv.querySelector('img');
          if (img) {
            img.style.width = '150px';
            img.style.height = '150px';
            img.style.display = 'block';
            img.style.margin = '10px auto';
          }
        } catch (e) {
          console.error('QR code generation failed.:', e);
          qrDiv.innerHTML = '<p>QR code could not be generated.</p>';
        }
      }

      // 初期データの読み込み
      async function fetchTransactions() {
        try {
          const response = await fetch(API_ENDPOINTS.fetchTransactions, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ "Group-Url": groupUrl })
          });

          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          transactions = await response.json();
          updateTransactionList();
          calculateFinalBalances();
        } catch (error) {
          alert(error.message || "Failed to load transaction data.");
        }
      }

      // 初期化
      fetchTransactions();

      // 現在のページのURLをそのまま共有リンクとして表示
      const currentUrl = window.location.href;
      shareableLink.value = currentUrl || "The URL of the group is not saved.";

      // QRコードを生成
      generateQRCode(currentUrl);
    });
  </script>
</body>

</html>